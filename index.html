<!DOCTYPE html>
<head>
    <title>XCH Picker by Cass</title>
    <link rel="icon" type="image/x-icon" href="https://cassxch.com/csx/250/001.svg">
    <style>
        *,
        html { margin: 0; padding: 0; border: 0;}
        html { width: 100%; height: 100%;}
        body { width: 100%; height: 100%; background-color: rgb(0, 0, 0); display: flex; flex-direction: column;}
        
        .flex-container { display: flex; justify-content: space-between; flex-direction: column; height: 100%; padding: 15px; gap: 5px; }
        .flex-container > div{ padding: 8px; }
        .item { align-self:center; color: white; font-family: monospace; text-align: center; margin: 20px; font-size: xx-large; width: 100%;}
        input, button { font-size: xx-large; color: rgb(0, 49, 7); background-color: rgb(160, 199, 165); border: 1px solid #fafafa; border-radius: 5px; text-align: center;}
    </style>
</head>
<body>
<div class="flex-container">
    <div class="item">
        <h1>XCH PICKER by CASS<br></h1>
        <h2>Powered by  <a href="https://www.coinset.org/">coinset.org</a><br></h1>
    </div>
    <div class="item">
        <div class="item">
            <h2 id="H0">Current block height : syncing...<br></h1>
        </div>
        <div class="item" style="display: flex; justify-content: space-evenly">
            <label for="block">Block:</label>
            <input type="number" id="block" name="block" min="1" max="1000000000" value="6382792" />
        </div>
        <div class="item" style="display: flex; justify-content: space-evenly">
            <label for="range0">Range:</label>
            <input type="number" id="range0" name="range0" min="1" max="1000000000" value="420" />
        </div>
        <div class="item">    
            <button id="button1" style="padding: 10px 24px;">Verify</button>
        </div>
        <div class="item">    
            <p id="par0" style="color: rgb(255, 255, 255)">Waiting for verification</p>
        </div>
    </div>

    <div class="item">
        <a href="https://twitter.com/xchpicker?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-size="large" data-show-count="true">Follow @xchpicker</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        
    </div>
</div>
<script type="module">
    function numberWithSpaces(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function hash2rand(_header_hash, _max) {
        const safe_big_int = 281474976710655; // 0xffff ffff ffff 
        const HH_Int = parseInt(_header_hash.substring(0,14), 16)+1;
        // Check if within range, if not discard the header_hash
        if(HH_Int > Math.floor(safe_big_int/_max)*_max){
            return 0; 
        }else{
            return numberWithSpaces(((HH_Int % _max) + 1));
        }
    }

    async function post(_request) {
        try {
            const response = await fetch(_request);
            const result = await response.json();
            return result;
        } catch (error) {
            console.error("Error:", error);
        }
    };
    let current_height = 0;
    async function getHeight() {            
        const get_blockchain_state = new Request("https://api.coinset.org/get_blockchain_state", { method: "POST", body: JSON.stringify({}) });
        const blockchain_state = await post(get_blockchain_state);
        current_height = blockchain_state.blockchain_state.peak.height;
        const current_header_hash = blockchain_state.blockchain_state.peak.header_hash;

        document.getElementById('H0').innerHTML = "Current block height : " + current_height;
    }
    async function verifydraw(_height, _range) {
        const get_block_record_by_height = new Request("https://api.coinset.org/get_block_record_by_height", { method: "POST", body: JSON.stringify({"height": _height}) });
        const block_record = await post(get_block_record_by_height);
        const header_hash = block_record.block_record.header_hash;
        const rand = hash2rand(header_hash, _range);
        
        const link = "<a href=\"https://www.spacescan.io/block/" + _height + "\">" + _height + "</a>";
        const tweet = "<a href=\"https://twitter.com/intent/tweet?text=@xchpicker%20draw%0a%0aBlock:%20" + _height + "%0aRange:%20" + _range + "%0aResult:%20" + rand + "\">" + rand + "</a>";
        console.log(tweet);
        const payload = link + " - " + header_hash.substring(0,14) + "... - " + tweet;
        document.getElementById('par0').innerHTML = payload;
    };

    const myButton = document.getElementById('button1');
        myButton.addEventListener("click", (event) => {
            const height = parseInt(document.getElementById('block').value);
            const range = parseInt(document.getElementById('range0').value);
            getHeight();
            if(current_height < height){
                document.getElementById('par0').innerHTML = "Can't verify a block that has not been farmed yet...!";
            }else{
                verifydraw(height, range);
            }
    });
    getHeight();
</script>
</body>
</html>
