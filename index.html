<!DOCTYPE html>
<head>
    <title>XCH Picker by Cass</title>
    <link rel="icon" type="image/x-icon" href="https://cassxch.com/csx/250/001.svg">
    <style>
        *,
        html { margin: 0; padding: 0; border: 0;}
        html { width: 100%; height: 100%;}
        body { width: 100%; height: 100%; background-color: rgb(62, 189, 79); display: flex; flex-direction: column;}
        .center { width: 100%; margin: 0; color: white; font-family: monospace; text-align: center;}
    </style>
    
</head>
<body>
    <div class="center" id="top">
        <h1 style="margin-top: 50px">XCH PICKER by CASS<br></h1>
        <h2 style="margin: 20px">Powered by  <a href="https://www.coinset.org/">coinset.org</a><br></h1>
        <h2 id="H0" style="margin: 20px">Current block height : syncing...<br></h1>

        <label for="block">Block:</label>
        <input type="number" id="block" name="block" min="1" max="1000000000" value="6382792" />
        <label for="range0">Number Range:</label>
        <input type="number" id="range0" name="range0" min="1" max="1000000000" value="420" />
        <button id="button1">Verify</button>
        <p id="par0" style="color: rgb(0, 49, 7); margin: 20px">Waiting for verification</p>
    </div>

<script type="module">

    function hash2rand(header_hash, max) {
        const safe_big_int = 281474976710655; // 0xffff ffff ffff 
        const HH_Int = parseInt(header_hash.substring(0,14), 16)+1;
        // Check if within range, if not discard the header_hash
        if(HH_Int > Math.floor(safe_big_int/max)*max){
            return 0; 
        }else{
            return String(((HH_Int % max) + 1)).padStart(max.length, '0');
        }
    }

    async function post(request) {
        try {
            const response = await fetch(request);
            const result = await response.json();
            return result;
        } catch (error) {
            console.error("Error:", error);
        }
    };
    let current_height = 0;
    async function getHeight() {            
        const get_blockchain_state = new Request("https://api.coinset.org/get_blockchain_state", { method: "POST", body: JSON.stringify({}) });
        const blockchain_state = await post(get_blockchain_state);
        current_height = blockchain_state.blockchain_state.peak.height;
        const current_header_hash = blockchain_state.blockchain_state.peak.header_hash;

        document.getElementById('H0').innerHTML = "Current block height : " + current_height;
    }
    async function verifydraw(_height, _range) {
        const get_block_record_by_height = new Request("https://api.coinset.org/get_block_record_by_height", { method: "POST", body: JSON.stringify({"height": _height}) });
        const block_record = await post(get_block_record_by_height);
        const header_hash = block_record.block_record.header_hash;
        const rand = hash2rand(header_hash, _range)
        const payload = _height + " - " + header_hash + " - " + rand
        document.getElementById('par0').innerHTML = payload;
    };

    const myButton = document.getElementById('button1');
        myButton.addEventListener("click", (event) => {
            const height = parseInt(document.getElementById('block').value);
            const range = parseInt(document.getElementById('range0').value);
            getHeight();
            if(current_height < height){
                document.getElementById('par0').innerHTML = "Can't verify a block that has not been farmed yet...!";
            }else{
                verifydraw(height, range);
            }
    });
    getHeight();
</script>
</body>
</html>
